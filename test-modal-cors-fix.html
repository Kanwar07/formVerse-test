<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal CORS Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { border-color: #4CAF50; background-color: #f0f8f0; }
        .error { border-color: #f44336; background-color: #fff0f0; }
        .warning { border-color: #ff9800; background-color: #fff8f0; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a8b; }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Modal CORS Fix Test</h1>
    <p>This test verifies that our CORS fix prevents malformed Supabase Storage URLs.</p>

    <div id="test1" class="test-section">
        <h3>Test 1: Modal URL Detection</h3>
        <p>Testing if Modal URLs are correctly detected and handled.</p>
        <button onclick="testModalUrlDetection()">Run Test</button>
        <div id="test1-result"></div>
    </div>

    <div id="test2" class="test-section">
        <h3>Test 2: Supabase URL Construction Prevention</h3>
        <p>Testing that Modal URLs don't get passed to Supabase getPublicUrl.</p>
        <button onclick="testSupabaseUrlPrevention()">Run Test</button>
        <div id="test2-result"></div>
    </div>

    <div id="test3" class="test-section">
        <h3>Test 3: Edge Function Proxy</h3>
        <p>Testing the Edge Function proxy endpoint.</p>
        <button onclick="testEdgeFunctionProxy()">Run Test</button>
        <div id="test3-result"></div>
    </div>

    <div id="logs" class="test-section">
        <h3>Test Logs</h3>
        <div id="log-output" class="log"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script>
        const MODAL_URL = 'https://formversedude--cadqua-3d-api-fastapi-app.modal.run/download/glb/test123';
        const REGULAR_PATH = 'user123/models/test.glb';
        
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-output').textContent = '';
        }

        function testModalUrlDetection() {
            log('=== Test 1: Modal URL Detection ===');
            
            const isModalUrl = MODAL_URL.includes('formversedude--cadqua-3d-api-fastapi-app.modal.run/download/');
            const isRegularPath = REGULAR_PATH.includes('formversedude--cadqua-3d-api-fastapi-app.modal.run/download/');
            
            log(`Modal URL: ${MODAL_URL}`);
            log(`Is Modal URL detected: ${isModalUrl}`);
            log(`Regular path: ${REGULAR_PATH}`);
            log(`Is Regular path detected as Modal: ${isRegularPath}`);
            
            const test1Result = document.getElementById('test1-result');
            if (isModalUrl && !isRegularPath) {
                test1Result.innerHTML = '<p style="color: green;">✅ PASS: Modal URL detection works correctly</p>';
                document.getElementById('test1').className = 'test-section success';
                log('✅ Test 1 PASSED');
            } else {
                test1Result.innerHTML = '<p style="color: red;">❌ FAIL: Modal URL detection failed</p>';
                document.getElementById('test1').className = 'test-section error';
                log('❌ Test 1 FAILED');
            }
        }

        function testSupabaseUrlPrevention() {
            log('=== Test 2: Supabase URL Construction Prevention ===');
            
            // Simulate the old behavior that would create malformed URLs
            const malformedUrl = `https://zqnzxpbthldfqqbzzjct.supabase.co/storage/v1/object/public/3d-models/${MODAL_URL}`;
            
            log(`This is what the malformed URL would look like:`);
            log(`${malformedUrl}`);
            log(`Length: ${malformedUrl.length} characters`);
            
            // Check if our fix prevents this
            const isModalUrl = MODAL_URL.includes('formversedude--cadqua-3d-api-fastapi-app.modal.run/download/');
            const shouldUseDirectUrl = isModalUrl;
            
            log(`Should use direct URL instead of Supabase public URL: ${shouldUseDirectUrl}`);
            
            const test2Result = document.getElementById('test2-result');
            if (shouldUseDirectUrl) {
                test2Result.innerHTML = '<p style="color: green;">✅ PASS: Modal URLs will be used directly, preventing malformed Supabase URLs</p>';
                document.getElementById('test2').className = 'test-section success';
                log('✅ Test 2 PASSED');
            } else {
                test2Result.innerHTML = '<p style="color: red;">❌ FAIL: Modal URLs might still create malformed Supabase URLs</p>';
                document.getElementById('test2').className = 'test-section error';
                log('❌ Test 2 FAILED');
            }
        }

        async function testEdgeFunctionProxy() {
            log('=== Test 3: Edge Function Proxy ===');
            
            const EDGE_FUNCTION_URL = 'https://zqnzxpbthldfqqbzzjct.supabase.co/functions/v1/modal-image-to-cad?action=download';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpxbnp4cGJ0aGxkZnFxYnp6amN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5MzIxNzgsImV4cCI6MjA2NDUwODE3OH0.7YWUyL31eeOtauM4TqHjQXm8PB1Y-wVB7Cj0dSMQ0SA';
            
            log(`Testing Edge Function at: ${EDGE_FUNCTION_URL}`);
            
            const test3Result = document.getElementById('test3-result');
            
            try {
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: 'test123',
                        file_type: 'glb',
                        api_base_url: 'https://formversedude--cadqua-3d-api-fastapi-app.modal.run'
                    })
                });
                
                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    log(`Content-Type: ${contentType}`);
                    
                    if (contentType && contentType.includes('application/octet-stream')) {
                        const blob = await response.blob();
                        log(`Received blob of size: ${blob.size} bytes`);
                        
                        test3Result.innerHTML = '<p style="color: green;">✅ PASS: Edge Function proxy is working</p>';
                        document.getElementById('test3').className = 'test-section success';
                        log('✅ Test 3 PASSED');
                    } else {
                        const text = await response.text();
                        log(`Response body: ${text}`);
                        
                        test3Result.innerHTML = '<p style="color: orange;">⚠️ WARNING: Edge Function responded but with unexpected content type</p>';
                        document.getElementById('test3').className = 'test-section warning';
                        log('⚠️ Test 3 WARNING');
                    }
                } else {
                    const errorText = await response.text();
                    log(`Error response: ${errorText}`);
                    
                    // This might be expected if the Modal service is down or the task doesn't exist
                    test3Result.innerHTML = '<p style="color: orange;">⚠️ WARNING: Edge Function responded with error (expected if Modal service is down)</p>';
                    document.getElementById('test3').className = 'test-section warning';
                    log('⚠️ Test 3 WARNING (expected if Modal service is down)');
                }
            } catch (error) {
                log(`Error: ${error.message}`);
                test3Result.innerHTML = '<p style="color: red;">❌ FAIL: Could not reach Edge Function</p>';
                document.getElementById('test3').className = 'test-section error';
                log('❌ Test 3 FAILED');
            }
        }

        // Auto-run all tests on page load
        window.addEventListener('load', () => {
            log('=== Starting Automated Tests ===');
            testModalUrlDetection();
            setTimeout(testSupabaseUrlPrevention, 1000);
            setTimeout(testEdgeFunctionProxy, 2000);
        });
    </script>
</body>
</html>
